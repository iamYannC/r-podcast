Strategy for CI/CD export formats (SQLite + XLSX)

Context (current CI/CD design)
- Workflow: .github/workflows/update.yaml
  - schedule: Monday 00:00 UTC for update, 1st of month for cleanup
  - steps: checkout -> setup R -> install deps -> run cicd/update.R -> run cicd/export_formats.R
  - commit step currently adds outputs/*.rds and outputs/snapshots/*.rds only
- CICD scripts:
  - cicd/update.R: updates meta/transcripts/chapters/descriptions + snapshot
  - cicd/export_formats.R: writes outputs/sqlitedb/rweekly.sqlite + outputs/xlsx/rweekly.xlsx
  - cicd/cleanup_snapshots.R: keeps 3 latest snapshots

Decisions + reasoning

1) Keep exports in CI/CD as a post-update step (current pattern)
Decision: continue to run cicd/export_formats.R after cicd/update.R in the same workflow job.
Reason: exports should always reflect the latest snapshot; running them in the same job ensures consistent artifacts without requiring a second workflow or complicated handoffs.

2) Decide whether exports are committed or only published as artifacts
Decision: prefer committing exports alongside snapshots, unless repo size becomes an issue.
Reason: the project already commits snapshots and RDS outputs, so committing exports is consistent and improves discoverability for non-R users; artifacts are optional but add maintenance overhead.

3) Update the commit step to include export outputs
Decision: include outputs/sqlitedb/*.sqlite and outputs/xlsx/*.xlsx in the git add list.
Reason: current commit step ignores exports, so CI writes files but never persists them; adding these paths makes the export step meaningful.

4) Naming consistency for CI exports
Decision: keep deterministic filenames (e.g., rweekly.sqlite and rweekly.xlsx) for CI outputs.
Reason: deterministic names prevent repo churn and let users download “latest” without scanning for dates; snapshot history already covers historical versions.

5) Output directory normalization
Decision: keep CI exports under outputs/sqlitedb and outputs/xlsx as already implemented in cicd/export_formats.R.
Reason: aligning CI with current script avoids unnecessary changes; the repo already has these paths, so updating them would require a migration without functional gain.

6) Guard against empty or partial exports
Decision: add a lightweight pre-check in cicd/export_formats.R: ensure meta has rows and required columns before writing.
Reason: CI should fail fast on schema drift or empty data to avoid publishing bad exports; a simple check keeps maintenance low.

7) Transaction safety for SQLite writes
Decision: wrap dbWriteTable calls in a transaction (dbBegin/dbCommit with on.exit rollback).
Reason: ensures the SQLite file isn’t left half-written if a write fails; CI reruns can then recover cleanly.

8) XLSX cell-size constraints for transcripts
Decision: if transcripts are too long for Excel cells, optionally truncate and add a boolean flag column.
Reason: Excel has cell-length limits; explicit truncation with a flag avoids silent data loss and makes the limitation obvious.

9) CI logging / observability
Decision: log export paths and row counts to the workflow output (message() lines already visible in Actions logs).
Reason: makes it easy to verify what was produced in each run without pulling artifacts.

10) Cleanup scope
Decision: keep cleanup limited to snapshots only (no automatic removal of exports).
Reason: exports are deterministic and overwrite in place; removing them adds no benefit and risks deleting the latest files.

Proposed CI adjustments (high level)
- In .github/workflows/update.yaml commit step, add:
  - outputs/sqlitedb/*.sqlite
  - outputs/xlsx/*.xlsx
- Optional: add a short “Show export stats” step that prints file sizes to logs.

Suggested script tweaks (cicd/export_formats.R)
- Validate: ensure data$meta has episode_slug and at least 1 row.
- SQLite: use dbBegin/dbCommit, with rollback on error.
- XLSX: optionally handle transcript length and log truncations.

Acceptance criteria (what done looks like)
- CI run produces updated RDS + snapshot + SQLite + XLSX when new episodes exist.
- The commit includes export files so they appear in the repo.
- Logs clearly indicate export success and output paths.
